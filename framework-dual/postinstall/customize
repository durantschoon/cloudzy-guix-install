#!/run/current-system/profile/bin/bash
# Framework 13 Laptop Customization Tool
# Optimized for Framework 13 dual-boot with Pop!_OS

set -euo pipefail

CONFIG_FILE="/etc/config.scm"
BACKUP_DIR="$HOME/.config/guix-customize/backups"

# Source shared library functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
source "$REPO_ROOT/postinstall/lib.sh"

# Add NetworkManager service (platform-specific)
add_networkmanager() {
  msg "Adding NetworkManager Service"

  if grep -q "network-manager-service-type" "$CONFIG_FILE"; then
    warn "NetworkManager already configured"
    return
  fi

  # Also check if wpa-supplicant is already there (might be added separately)
  local has_wpa=false
  if grep -q "wpa-supplicant-service-type" "$CONFIG_FILE"; then
    has_wpa=true
  fi

  backup_config

  # Use Guile helper to add services
  # Note: NetworkManager requires wpa-supplicant-service-type (provides 'wireless-daemon')

  # Add wpa-supplicant first if not already present
  if [ "$has_wpa" = false ]; then
    if ! guile_add_service "(gnu services networking)" "(service wpa-supplicant-service-type)"; then
      err "Failed to add wpa-supplicant service"
      err "Please add services manually to /etc/config.scm"
      return 1
    fi
  fi

  # Add NetworkManager
  if guile_add_service "(gnu services networking)" "(service network-manager-service-type)"; then
    if [ "$has_wpa" = true ]; then
      info "✓ NetworkManager service added (wpa-supplicant was already configured)"
    else
      info "✓ NetworkManager and wpa-supplicant services added"
    fi
  else
    err "Failed to add NetworkManager service"
    err "Please add services manually to /etc/config.scm"
    return 1
  fi
  info "After reconfigure, use: nmcli device wifi list"
  info "                   and: nmcli device wifi connect SSID --ask"
}

# Add Framework 13 specific customizations (platform-specific)
add_framework_hardware() {
  msg "Adding Framework 13 Hardware Support"

  if grep -q "linux-firmware" "$CONFIG_FILE"; then
    warn "Hardware firmware already configured"
    return
  fi

  backup_config

  # Add firmware module
  if ! grep -q "(gnu packages linux)" "$CONFIG_FILE"; then
    safe_edit_config '/^(use-modules/a\             (gnu packages linux)'
  fi

  # Add firmware to operating-system
  safe_edit_config '/^(operating-system/a\ (firmware (list linux-firmware))'

  info "✓ Added WiFi/Bluetooth firmware (linux-firmware)"
  info "Note: For best results, also add nonguix channel for proprietary firmware"
}

# Main menu
main_menu() {
  while true; do
    clear_screen
    msg "Framework 13 Laptop Customization Tool"
    echo ""
    echo "Platform: Framework 13 (Dual-boot with Pop!_OS)"
    echo "Current config: $CONFIG_FILE"
    echo ""
    echo "CRITICAL FOR WIFI (do these first):"
    echo "  0) Add NetworkManager service (required for WiFi connectivity)"
    echo "  4) Add Framework 13 hardware support (WiFi/BT firmware)"
    echo ""
    echo "Desktop Environment:"
    echo "  2) Add desktop environment (GNOME/Xfce/MATE/LXQt)"
    echo ""
    echo "Essential Services:"
    echo "  1) Add SSH service (optional for laptop)"
    echo "  3) Add common packages (git, vim, emacs, etc.)"
    echo ""
    echo "Advanced:"
    echo "  5) Show nonguix channel info (proprietary software)"
    echo ""
    echo "Shared Recipes:"
    echo "  s) Install Spacemacs (Emacs distribution)"
    echo "  d) Install development tools (git, vim, python, etc.)"
    echo "  f) Install fonts (Fira Code, JetBrains Mono, etc.)"
    echo ""
    echo "Actions:"
    echo "  r) Apply changes (reconfigure system)"
    echo "  e) Edit config manually"
    echo "  v) View current config"
    echo "  q) Quit"
    echo ""
    info "Tip: Run option 0 and 4, then 'r' to reconfigure and get WiFi working"
    echo ""
    read -r -p "Select option: " choice

    case "$choice" in
      0) add_networkmanager; read -p "Press Enter to continue..." ;;
      1) add_ssh; read -p "Press Enter to continue..." ;;
      2) add_desktop; read -p "Press Enter to continue..." ;;
      3) add_packages; read -p "Press Enter to continue..." ;;
      4) add_framework_hardware; read -p "Press Enter to continue..." ;;
      5) add_nonguix_info; read -p "Press Enter to continue..." ;;
      s) source "$REPO_ROOT/postinstall/recipes/add-spacemacs.sh" && add_spacemacs; read -p "Press Enter to continue..." ;;
      d) source "$REPO_ROOT/postinstall/recipes/add-development.sh" && add_development; read -p "Press Enter to continue..." ;;
      f) source "$REPO_ROOT/postinstall/recipes/add-fonts.sh" && add_fonts; read -p "Press Enter to continue..." ;;
      r) reconfigure; read -p "Press Enter to continue..." ;;
      e) edit_config; read -p "Press Enter to continue..." ;;
      v) view_config ;;
      q) msg "Goodbye!"; exit 0 ;;
      *) err "Invalid option"; sleep 1 ;;
    esac
  done
}

# Check if running as root
if [[ $EUID -eq 0 ]]; then
  err "Do not run this script as root"
  info "Run as normal user (will prompt for sudo when needed)"
  exit 1
fi

# Check if config exists
if [[ ! -f "$CONFIG_FILE" ]]; then
  err "Config file not found: $CONFIG_FILE"
  info "Are you running this on an installed Guix system?"
  exit 1
fi

# Run main menu
main_menu
