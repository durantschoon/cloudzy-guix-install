#!/run/current-system/profile/bin/bash
# Framework 13 Laptop Customization Tool
# Optimized for Framework 13 dual-boot with Pop!_OS

set -euo pipefail

CONFIG_FILE="/etc/config.scm"
BACKUP_DIR="$HOME/.config/guix-customize/backups"

# Colors for output
msg() { printf "\n\033[1;34m==> %s\033[0m\n" "$*"; }
warn() { printf "\n\033[1;33m[warn]\033[0m %s\n" "$*"; }
err() { printf "\n\033[1;31m[err]\033[0m  %s\n" "$*"; }
info() { printf "  %s\n" "$*"; }

ask_yes() {
  local prompt="$1"
  read -r -p "$prompt [y/N] " ans
  [[ "$ans" =~ ^[Yy]$ ]]
}

# Backup current config
backup_config() {
  mkdir -p "$BACKUP_DIR"
  local backup_file="$BACKUP_DIR/config.scm.$(date +%Y%m%d-%H%M%S)"
  sudo cp "$CONFIG_FILE" "$backup_file"
  sudo chown "$USER:$USER" "$backup_file"
  info "Backed up config to: $backup_file"
}

# Helper function to safely edit /etc/config.scm
# Usage: safe_edit_config "sed command"
safe_edit_config() {
  local sed_cmd="$1"
  local tmp_file=$(mktemp)

  # Copy config to temp file (readable by user)
  sudo cp "$CONFIG_FILE" "$tmp_file"
  sudo chown "$USER:$USER" "$tmp_file"

  # Apply sed command to temp file
  eval "sed -i '$sed_cmd' '$tmp_file'"

  # Copy back with sudo
  sudo cp "$tmp_file" "$CONFIG_FILE"
  rm -f "$tmp_file"
}

# Add NetworkManager service
add_networkmanager() {
  msg "Adding NetworkManager Service"

  if grep -q "network-manager-service-type" "$CONFIG_FILE"; then
    warn "NetworkManager already configured"
    return
  fi

  # Also check if wpa-supplicant is already there (might be added separately)
  local has_wpa=false
  if grep -q "wpa-supplicant-service-type" "$CONFIG_FILE"; then
    has_wpa=true
  fi

  backup_config

  # Add networking module if not present
  if ! grep -q "(gnu services networking)" "$CONFIG_FILE"; then
    safe_edit_config '/^(use-modules/a\             (gnu services networking)'
  fi

  # Add NetworkManager service to services list
  # Note: NetworkManager requires wpa-supplicant-service-type (provides 'wireless-daemon')
  if grep -q "(services %base-services))" "$CONFIG_FILE"; then
    # Simple services list - replace with append
    # Must preserve the closing paren for operating-system
    safe_edit_config 's|(services %base-services))|(services\n  (append\n   (list (service wpa-supplicant-service-type)\n         (service network-manager-service-type))\n   %base-services)))|'
  elif grep -q "(services (append" "$CONFIG_FILE"; then
    # Already has append, add to existing list
    safe_edit_config '0,/(list /s|(list |(list (service wpa-supplicant-service-type)\n         (service network-manager-service-type)\n         |'
  else
    err "Could not find services definition in config.scm"
    err "Please add NetworkManager manually"
    return 1
  fi

  if [ "$has_wpa" = true ]; then
    info "✓ NetworkManager service added (wpa-supplicant was already configured)"
  else
    info "✓ NetworkManager and wpa-supplicant services added"
  fi
  info "After reconfigure, use: nmcli device wifi list"
  info "                   and: nmcli device wifi connect SSID --ask"
}

# Add SSH service
add_ssh() {
  msg "Adding SSH Service"

  if grep -q "openssh-service-type" "$CONFIG_FILE"; then
    warn "SSH service already configured"
    return
  fi

  backup_config

  # Add ssh module if not present
  if ! grep -q "(gnu services ssh)" "$CONFIG_FILE"; then
    safe_edit_config '/^(use-modules/a\             (gnu services ssh)'
  fi

  # Add SSH service to services list
  if grep -q "(services %base-services))" "$CONFIG_FILE"; then
    # Simple services list - replace with append
    # Must preserve the closing paren for operating-system
    safe_edit_config 's|(services %base-services))|(services\n  (append\n   (list (service openssh-service-type))\n   %base-services)))|'
  elif grep -q "(services (append" "$CONFIG_FILE"; then
    # Already has append, add to existing list
    safe_edit_config '0,/(list /s|(list |(list (service openssh-service-type)\n         |'
  else
    err "Could not find services definition in config.scm"
    err "Please add SSH manually"
    return 1
  fi

  info "✓ SSH service added"
  info "After reconfigure, SSH will be available on port 22"
}

# Add desktop environment
add_desktop() {
  msg "Desktop Environment Selection"
  echo ""
  echo "Available desktop environments:"
  echo "  1) GNOME   - Full-featured, modern desktop"
  echo "  2) Xfce    - Lightweight, traditional desktop"
  echo "  3) MATE    - Classic GNOME 2 experience"
  echo "  4) LXQt    - Very lightweight, minimal resources"
  echo "  0) Cancel"
  echo ""
  read -r -p "Select desktop [1-4, 0 to cancel]: " choice

  case "$choice" in
    1) desktop="gnome"; service="gnome-desktop-service-type" ;;
    2) desktop="xfce"; service="xfce-desktop-service-type" ;;
    3) desktop="mate"; service="mate-desktop-service-type" ;;
    4) desktop="lxqt"; service="lxqt-desktop-service-type" ;;
    0) info "Cancelled"; return ;;
    *) err "Invalid choice"; return 1 ;;
  esac

  if grep -q "desktop-service-type" "$CONFIG_FILE"; then
    warn "Desktop environment already configured"
    return
  fi

  backup_config

  # Add desktop module if not present
  if ! grep -q "(gnu services desktop)" "$CONFIG_FILE"; then
    safe_edit_config '/^(use-modules/a\             (gnu services desktop)'
  fi

  # Add desktop service
  if grep -q "(services %base-services))" "$CONFIG_FILE"; then
    # Simple services list - replace with append
    # Must preserve the closing paren for operating-system
    safe_edit_config "s|(services %base-services))|(services\n  (append\n   (list (service $service))\n   %base-services)))|"
  elif grep -q "(services (append" "$CONFIG_FILE"; then
    # Already has append, add to existing list
    safe_edit_config "0,/(list /s|(list |(list (service $service)\n         |"
  else
    err "Could not find services definition in config.scm"
    err "Please add desktop manually"
    return 1
  fi

  info "✓ $desktop desktop added"
}

# Add common packages
add_packages() {
  msg "Adding Common Packages"

  if grep -q "specification->package" "$CONFIG_FILE"; then
    warn "Custom packages already defined"
    return
  fi

  backup_config

  # Replace minimal packages with useful defaults
  safe_edit_config 's|(packages %base-packages)|(packages\n  (append (list (specification->package "emacs")\n                (specification->package "git")\n                (specification->package "vim")\n                (specification->package "htop")\n                (specification->package "curl")\n                (specification->package "wget"))\n          %base-packages))|'

  info "✓ Added: emacs, git, vim, htop, curl, wget"
}

# Add Framework 13 specific customizations
add_framework_hardware() {
  msg "Adding Framework 13 Hardware Support"

  if grep -q "linux-firmware" "$CONFIG_FILE"; then
    warn "Hardware firmware already configured"
    return
  fi

  backup_config

  # Add firmware module
  if ! grep -q "(gnu packages linux)" "$CONFIG_FILE"; then
    safe_edit_config '/^(use-modules/a\             (gnu packages linux)'
  fi

  # Add firmware to operating-system
  safe_edit_config '/^(operating-system/a\ (firmware (list linux-firmware))'

  info "✓ Added WiFi/Bluetooth firmware (linux-firmware)"
  info "Note: For best results, also add nonguix channel for proprietary firmware"
}

# Add nonguix channel info
add_nonguix_info() {
  msg "Nonguix Channel (for proprietary software/firmware)"
  echo ""
  info "Nonguix provides:"
  info "  - Proprietary firmware (WiFi, graphics drivers)"
  info "  - Non-free software (Steam, Discord, etc.)"
  echo ""

  # Source postinstall library
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -f "$SCRIPT_DIR/../../lib/postinstall.sh" ]]; then
    source "$SCRIPT_DIR/../../lib/postinstall.sh"
  fi

  # Generate channels.scm with regional mirrors
  local channels_file="$HOME/.config/guix/channels.scm"
  mkdir -p "$(dirname "$channels_file")"

  if ask_yes "Generate channels.scm with regional mirror optimization?" default_yes; then
    generate_channels_scm > "$channels_file"
    success "Created $channels_file with optimized mirrors"
    echo ""
    cat "$channels_file"
    echo ""
    info "Then run: guix pull && sudo guix system reconfigure /etc/config.scm"
  else
    info "To add nonguix channel manually, create ~/.config/guix/channels.scm:"
    echo ""
    cat <<'EOF'
(cons* (channel
        (name 'nonguix)
        (url "https://gitlab.com/nonguix/nonguix")
        (branch "master")
        (introduction
         (make-channel-introduction
          "897c1a470da759236cc11798f4e0a5f7d4d59fbc"
          (openpgp-fingerprint
           "2A39 3FFF 68F4 EF7A 3D29  12AF 6F51 20A0 22FB B2D5"))))
       %default-channels)
EOF
    echo ""
    info "Then run: guix pull && sudo guix system reconfigure /etc/config.scm"
  fi
}

# Apply changes (reconfigure system)
reconfigure() {
  msg "System Reconfigure"
  echo ""
  info "This will apply all changes to your system."
  info "Current config: $CONFIG_FILE"
  echo ""

  if ! ask_yes "Proceed with system reconfigure?"; then
    info "Cancelled"
    return
  fi

  sudo guix system reconfigure "$CONFIG_FILE"
}

# Main menu
main_menu() {
  while true; do
    # Clear screen if clear command is available, otherwise just print separator
    command -v clear >/dev/null 2>&1 && clear || printf "\n\n========================================\n\n"
    msg "Framework 13 Laptop Customization Tool"
    echo ""
    echo "Platform: Framework 13 (Dual-boot with Pop!_OS)"
    echo "Current config: $CONFIG_FILE"
    echo ""
    echo "CRITICAL FOR WIFI (do these first):"
    echo "  0) Add NetworkManager service (required for WiFi connectivity)"
    echo "  4) Add Framework 13 hardware support (WiFi/BT firmware)"
    echo ""
    echo "Desktop Environment:"
    echo "  2) Add desktop environment (GNOME/Xfce/MATE/LXQt)"
    echo ""
    echo "Essential Services:"
    echo "  1) Add SSH service (optional for laptop)"
    echo "  3) Add common packages (git, vim, emacs, etc.)"
    echo ""
    echo "Advanced:"
    echo "  5) Show nonguix channel info (proprietary software)"
    echo ""
    echo "Shared Recipes:"
    echo "  s) Install Spacemacs (Emacs distribution)"
    echo "  d) Install development tools (git, vim, python, etc.)"
    echo "  f) Install fonts (Fira Code, JetBrains Mono, etc.)"
    echo ""
    echo "Actions:"
    echo "  r) Apply changes (reconfigure system)"
    echo "  e) Edit config manually"
    echo "  v) View current config"
    echo "  q) Quit"
    echo ""
    info "Tip: Run option 0 and 4, then 'r' to reconfigure and get WiFi working"
    echo ""
    read -r -p "Select option: " choice

    case "$choice" in
      0) add_networkmanager; read -p "Press Enter to continue..." ;;
      1) add_ssh; read -p "Press Enter to continue..." ;;
      2) add_desktop; read -p "Press Enter to continue..." ;;
      3) add_packages; read -p "Press Enter to continue..." ;;
      4) add_framework_hardware; read -p "Press Enter to continue..." ;;
      5) add_nonguix_info; read -p "Press Enter to continue..." ;;
      s) source "$(dirname "$0")/../../postinstall/recipes/add-spacemacs.sh" && add_spacemacs; read -p "Press Enter to continue..." ;;
      d) source "$(dirname "$0")/../../postinstall/recipes/add-development.sh" && add_development; read -p "Press Enter to continue..." ;;
      f) source "$(dirname "$0")/../../postinstall/recipes/add-fonts.sh" && add_fonts; read -p "Press Enter to continue..." ;;
      r) reconfigure; read -p "Press Enter to continue..." ;;
      e)
        # Try editors in order of preference
        if command -v "${EDITOR}" >/dev/null 2>&1; then
          "${EDITOR}" "$CONFIG_FILE"
        elif command -v nano >/dev/null 2>&1; then
          nano "$CONFIG_FILE"
        elif command -v vi >/dev/null 2>&1; then
          vi "$CONFIG_FILE"
        else
          err "No editor found. Install nano or set EDITOR variable"
        fi
        read -p "Press Enter to continue..."
        ;;
      v)
        # Try pagers in order of preference
        if command -v less >/dev/null 2>&1; then
          less "$CONFIG_FILE"
        elif command -v more >/dev/null 2>&1; then
          more "$CONFIG_FILE"
        else
          cat "$CONFIG_FILE" | head -100
          info "Install 'less' for better viewing (currently showing first 100 lines)"
          read -p "Press Enter to continue..."
        fi
        ;;
      q) msg "Goodbye!"; exit 0 ;;
      *) err "Invalid option"; sleep 1 ;;
    esac
  done
}

# Check if running as root
if [[ $EUID -eq 0 ]]; then
  err "Do not run this script as root"
  info "Run as normal user (will prompt for sudo when needed)"
  exit 1
fi

# Check if config exists
if [[ ! -f "$CONFIG_FILE" ]]; then
  err "Config file not found: $CONFIG_FILE"
  info "Are you running this on an installed Guix system?"
  exit 1
fi

# Run main menu
main_menu
