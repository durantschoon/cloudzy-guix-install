#!/run/current-system/profile/bin/bash
# VPS Server Customization Tool
# Optimized for headless VPS/server environments (Cloudzy, DigitalOcean, AWS, etc.)

set -euo pipefail

CONFIG_FILE="/etc/config.scm"
BACKUP_DIR="$HOME/.config/guix-customize/backups"

# Source shared library functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Find postinstall/lib.sh relative to customize script location
# Structure: ~/guix-customize/cloudzy/postinstall/customize
# We need: ~/guix-customize/postinstall/lib.sh
INSTALL_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
if [ -f "$INSTALL_ROOT/postinstall/lib.sh" ]; then
  source "$INSTALL_ROOT/postinstall/lib.sh"
else
  echo "Error: postinstall/lib.sh not found at $INSTALL_ROOT/postinstall/lib.sh"
  echo "Please run bootstrap-postinstall.scm first to download all required files."
  exit 1
fi

# Main menu
main_menu() {
  while true; do
    clear_screen
    msg "VPS Server Customization Tool"
    echo ""
    echo "Platform: Cloudzy / VPS / Cloud Server"
    echo "Current config: $CONFIG_FILE"
    echo ""
    echo "Essential Services:"
    echo "  1) Add SSH service (required for remote access)"
    echo "  3) Add common packages (git, vim, emacs, go, etc.)"
    echo ""
    echo "Server Features:"
    echo "  5) Show nonguix channel info (proprietary software)"
    echo ""
    echo "Shared Recipes:"
    echo "  s) Install Spacemacs (Emacs distribution)"
    echo "  d) Install development tools (git, vim, python, etc.)"
    echo "  f) Install fonts (Fira Code, JetBrains Mono, etc.)"
    echo ""
    echo "Actions:"
    echo "  r) Apply changes (reconfigure system)"
    echo "  e) Edit config manually"
    echo "  v) View current config"
    echo "  q) Quit"
    echo ""
    info "Note: This is a VPS-focused tool. Desktop/hardware features removed."
    info "      For Framework 13 laptop, use framework-dual/postinstall/customize"
    echo ""
    read -r -p "Select option: " choice

    case "$choice" in
      1) add_ssh; read -p "Press Enter to continue..." ;;
      3) add_packages; read -p "Press Enter to continue..." ;;
      5) add_nonguix_info; read -p "Press Enter to continue..." ;;
      s) source "$REPO_ROOT/postinstall/recipes/add-spacemacs.sh" && add_spacemacs; read -p "Press Enter to continue..." ;;
      d) source "$REPO_ROOT/postinstall/recipes/add-development.sh" && add_development; read -p "Press Enter to continue..." ;;
      f) source "$REPO_ROOT/postinstall/recipes/add-fonts.sh" && add_fonts; read -p "Press Enter to continue..." ;;
      r) reconfigure; read -p "Press Enter to continue..." ;;
      e) edit_config; read -p "Press Enter to continue..." ;;
      v) view_config ;;
      q) msg "Goodbye!"; exit 0 ;;
      *) err "Invalid option"; sleep 1 ;;
    esac
  done
}

# Check if running as root
if [[ $EUID -eq 0 ]]; then
  err "Do not run this script as root"
  info "Run as normal user (will prompt for sudo when needed)"
  exit 1
fi

# Check if config exists
if [[ ! -f "$CONFIG_FILE" ]]; then
  err "Config file not found: $CONFIG_FILE"
  info "Are you running this on an installed Guix system?"
  exit 1
fi

# Run main menu
main_menu
